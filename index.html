<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
  <meta name="google-site-verification" content="vWPzVR2LgS1BRRLWZISZIsTuSbgiQNlZjlcZGINDrfY" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>WB STG Learning — Final</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#071226; --panel:#0b1220; --panel2:#0f1e35; --muted:#9aa4b2;
    --accent1:#7c3aed; --accent2:#4f46e5; --primary:#7c3aed; --radius:12px; --text:#e6eef8;
    --success:#22c55e; --danger:#ef4444;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071226 0%, #041523 80%);color:var(--text);-webkit-font-smoothing:antialiased}
  a{color:inherit}
  .container{max-width:1100px;margin:12px auto;padding:12px}

  /* topbar */
  .topbar{display:flex;align-items:center;gap:12px;padding:12px 0}
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{width:44px;height:44px;border-radius:10px;object-fit:cover;box-shadow:0 8px 28px rgba(2,6,23,0.5)}
  .brand h1{margin:0;font-size:18px}
  .spacer{flex:1}
  .search input{width:420px;max-width:60vw;padding:10px 12px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:inherit}

  /* layout */
  .wrapper{display:grid;grid-template-columns:260px 1fr;gap:16px;margin-top:12px}
  .sidebar{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.02));padding:14px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03)}
  .sidebar ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
  .sidebar li{padding:10px;border-radius:8px;color:var(--muted);cursor:pointer;transition:background .12s}
  .sidebar li.active{background:linear-gradient(90deg, rgba(124,58,237,0.12), rgba(79,70,229,0.08));color:#fff}

  /* grid + cards */
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(2,6,23,0.5)}
  .courses{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
  .course-card{padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006));border:1px solid rgba(255,255,255,0.03);transition:transform .18s,box-shadow .18s}
  .course-card:hover{transform:translateY(-6px);box-shadow:0 20px 40px rgba(2,6,23,0.6)}
  .course-card h3{margin:0 0 8px}
  .small{font-size:13px;color:var(--muted)}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px}
  .badge.free{background:rgba(34,197,94,0.12);color:var(--success)}
  .badge.premium{background:rgba(255,165,0,0.1);color:#ffb020}
  .btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));padding:10px 14px;border-radius:10px;border:none;color:white;cursor:pointer;font-weight:600}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
  .btn.small{padding:8px 10px;font-size:14px;border-radius:8px}
  .page{display:none}
  .page.active{display:block}

  /* course view */
  .course-view .header{display:flex;align-items:center;gap:12px}
  .back-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:10px;color:var(--muted);cursor:pointer}
  .materials{margin-top:12px;display:flex;flex-direction:column;gap:10px}
  .subject{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:rgba(255,255,255,0.02)}
  .subject .title{font-weight:600}
  .subject button{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer}

  /* admin */
  .admin-controls{display:flex;gap:8px;margin-top:10px}
  .adminMaterial{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px}
  .admin-row{padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.02)}

  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.7);z-index:9999}
  .modal .box{width:min(940px,96vw);background:linear-gradient(180deg,#0b1220,#071026);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 20px 60px rgba(2,6,23,0.7);max-height:94vh;overflow:auto}
  .input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(0,0,0,0.75);color:white;padding:8px 12px;border-radius:8px;z-index:10000}

  /* animations */
  .animate-in{animation:fadeIn .28s ease both}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

  /* mobile */
  @media(max-width:880px){
    .wrapper{grid-template-columns:1fr}
    .search input{width:100%}
    .sidebar{display:flex;overflow:auto;gap:8px;padding:10px}
    .sidebar ul{display:flex;gap:8px}
    .sidebar li{white-space:nowrap;padding:8px 12px;border-radius:999px}
    .courses{grid-template-columns:1fr}
    .modal .box{width:94vw;padding:14px;border-radius:12px}
    .subject{flex-direction:column;align-items:flex-start;gap:8px}
    .subject button{width:100%}
    .course-card{padding:12px;border-radius:12px}
    .brand img{width:36px;height:36px}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <img src="https://i.ibb.co/mVz4Mbnh/wb-logo.jpg" alt="WB logo">
        <div>
          <h1>WB STG Learning</h1>
          <div class="small"></div>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="search"><input id="searchInput" placeholder="Search courses, topics..." /></div>
      <div style="width:12px"></div>

      <div class="user" id="userArea">
        <button id="openLogin" class="btn">Login / Signup</button>
      </div>
    </div>

    <div class="wrapper" style="margin-top:12px">
      <nav class="sidebar card" aria-label="Primary navigation">
        <ul>
          <li data-page="home" class="active">Home</li>
          <li data-page="courses">Courses</li>
          <li data-page="tests">Tests</li>
          <li data-page="notices">Notices</li>
          <li data-page="dashboard">Dashboard</li>
          <li data-page="admin" id="adminNav" style="display:none">Admin</li>
        </ul>
      </nav>

      <main class="main">
        <!-- HOME -->
        <section id="home" class="page card active">
          <h2>Featured</h2>
          <div id="featured" class="courses" style="margin-top:12px"></div>
        </section>

        <!-- COURSES -->
        <section id="courses" class="page card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h2>All Courses</h2>
            <div>
              <select id="filterType" class="input" style="padding:8px;border-radius:8px">
                <option value="all">All</option><option value="free">Free</option><option value="premium">Premium</option>
              </select>
            </div>
          </div>
          <div id="courseList" class="courses" style="margin-top:12px"></div>
        </section>

        <!-- TESTS -->
        <section id="tests" class="page card">
          <h2>Tests & Quizzes</h2>
          <div id="testList" style="margin-top:12px"></div>
        </section>

        <!-- NOTICES -->
        <section id="notices" class="page card">
          <h2>Notices</h2>
          <div id="noticeList" style="margin-top:12px"></div>
        </section>

        <!-- DASHBOARD -->
        <section id="dashboard" class="page card">
          <h2>Your Dashboard</h2>
          <div id="dashboardContent" style="margin-top:12px"></div>
        </section>

        <!-- COURSE VIEW -->
        <section id="courseView" class="page card">
          <div class="course-view">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="display:flex;gap:8px;align-items:center">
                <button class="back-btn" id="backBtn">⬅ Back</button>
                <h3 id="courseTitle">Course</h3>
              </div>
              <div id="courseType" class="small"></div>
            </div>
            <div id="materials" class="materials"></div>
          </div>
        </section>

        <!-- ADMIN -->
        <section id="admin" class="page card" style="display:none">
          <h2>Admin Panel</h2>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
            <div class="card">
              <h3>Create / Edit Course</h3>
              <input id="adminTitle" class="input" placeholder="Course title" />
              <textarea id="adminDesc" class="input" placeholder="Short description" style="min-height:80px;margin-top:8px"></textarea>
              <select id="adminType" class="input" style="margin-top:8px"><option value="free">Free</option><option value="premium">Premium</option></select>

              <div style="margin-top:8px"><strong>Materials (links)</strong></div>
              <div id="materialsEditor" style="display:flex;flex-direction:column;gap:8px;margin-top:8px;max-height:180px;overflow:auto"></div>

              <div style="display:flex;gap:8px;margin-top:8px">
                <input id="matTitle" class="input" placeholder="Material title" />
                <input id="matLink" class="input" placeholder="Material link (https://...)" />
                <button id="addMatBtn" class="btn" style="padding:8px 10px">Add</button>
              </div>

              <div style="display:flex;justify-content:flex-end;margin-top:8px">
                <button id="saveCourseBtn" class="btn">Create Course</button>
              </div>
            </div>

            <div class="card">
              <h3>Admin Lists</h3>
              <div id="adminCourses" style="margin-top:8px"></div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <div style="height:18px"></div>
    <footer style="text-align:center;color:var(--muted)">© 2026 WB STG Learning • All rights reserved</footer>
  </div>

  <!-- LOGIN MODAL -->
  <div class="modal" id="loginModal">
    <div class="box card" style="width:360px;padding:18px">
      <h3 style="margin:0 0 8px 0">Login / Signup</h3>
      <input id="loginEmail" class="input" placeholder="Email" />
      <input id="loginPassword" type="password" class="input" placeholder="Password (min 6)" />
      <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
        <button id="loginCancel" class="btn secondary">Cancel</button>
        <button id="loginSubmit" class="btn">Login / Signup</button>
      </div>
      <div class="small" style="margin-top:10px"> <strong></strong> </div>
    </div>
  </div>

  <!-- placeholder for dynamic modals -->
  <div id="dynamicModalContainer"></div>

  <div id="toast" style="display:none" class="toast"></div>

<script type="module">
/* ---------------- FIREBASE IMPORTS ---------------- */
import { auth, db } from './firebase.js';
import { signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
import { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, serverTimestamp, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

/* ---------------- CONFIG ---------------- */
const ADMIN_EMAIL = 'yusufkhanyk7310@gmail.com'; // admin
const WHATSAPP_NUMBER = '919330395465';

/* ---------------- UI REFS ---------------- */
const pages = document.querySelectorAll('.page');
const sidebarItems = document.querySelectorAll('.sidebar li');
const loginModal = document.getElementById('loginModal');
const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');
const loginSubmit = document.getElementById('loginSubmit');
const loginCancel = document.getElementById('loginCancel');
const openLogin = document.getElementById('openLogin');
const toastEl = document.getElementById('toast');

const featuredEl = document.getElementById('featured');
const courseListEl = document.getElementById('courseList');
const materialsEl = document.getElementById('materials');
const courseTitleEl = document.getElementById('courseTitle');
const courseTypeEl = document.getElementById('courseType');
const backBtn = document.getElementById('backBtn');

const adminNav = document.getElementById('adminNav');
const adminPage = document.getElementById('admin');

const adminTitle = document.getElementById('adminTitle');
const adminDesc = document.getElementById('adminDesc');
const adminType = document.getElementById('adminType');
const matTitle = document.getElementById('matTitle');
const matLink = document.getElementById('matLink');
const addMatBtn = document.getElementById('addMatBtn');
const materialsEditor = document.getElementById('materialsEditor');
const saveCourseBtn = document.getElementById('saveCourseBtn');
const adminCourses = document.getElementById('adminCourses');

const filterType = document.getElementById('filterType');
const searchInput = document.getElementById('searchInput');

const dynamicModalContainer = document.getElementById('dynamicModalContainer');

/* ---------------- STATE ---------------- */
let currentUser = null;
let userRole = null;
let coursesCache = [];
let currentOpenCourse = null;
let adminMaterials = [];

/* ---------------- HELPERS ---------------- */
function $(id){ return document.getElementById(id); }
function showToast(msg, t=2400){ toastEl.textContent = msg; toastEl.style.display = 'block'; setTimeout(()=> toastEl.style.display = 'none', t); }
function escapeHtml(s){ if(s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
function showPage(pageId){
  pages.forEach(p => p.classList.remove('active'));
  const p = document.getElementById(pageId);
  if(p){ p.classList.add('active'); p.classList.add('animate-in'); setTimeout(()=> p.classList.remove('animate-in'), 350); }
  sidebarItems.forEach(li => li.classList.toggle('active', li.dataset.page === pageId));
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
function showModal(html){ const c = document.createElement('div'); c.className='modal'; c.style.display='flex'; const box = document.createElement('div'); box.className='box card'; box.innerHTML = html; c.appendChild(box); dynamicModalContainer.appendChild(c); return { container: c, box }; }

/* ---------------- NAVIGATION ---------------- */
sidebarItems.forEach(li => {
  li.addEventListener('click', ()=> {
    const page = li.dataset.page;
    if(!page) return;
    showPage(page);
    if(page === 'courses' || page === 'home') loadCourses();
    if(page === 'tests') loadTests();
    if(page === 'notices') loadNotices();
    if(page === 'dashboard') renderDashboard();
    if(page === 'admin') loadAdminLists();
  });
});

/* ---------------- LOGIN FLOW ---------------- */
openLogin.addEventListener('click', ()=> { loginModal.style.display = 'flex'; loginEmail.focus(); });
loginCancel.addEventListener('click', ()=> { loginModal.style.display = 'none'; });

loginSubmit.addEventListener('click', async ()=> {
  const email = loginEmail.value.trim(); const pass = loginPassword.value;
  if(!email || pass.length < 6){ showToast('Enter email and min 6 char password'); return; }
  try{
    await signInWithEmailAndPassword(auth, email, pass);
    loginModal.style.display = 'none';
    loginEmail.value = loginPassword.value = '';
    showToast('Logged in');
  } catch(err){
    try{
      const res = await createUserWithEmailAndPassword(auth, email, pass);
      // register user
      await addDoc(collection(db,'users'), { uid: res.user.uid, email, role: email === ADMIN_EMAIL ? 'admin' : 'student', createdAt: serverTimestamp() });
      loginModal.style.display = 'none';
      loginEmail.value = loginPassword.value = '';
      showToast('Account created & logged in');
    } catch(e){
      console.error('auth error', e);
      showToast('Auth failed');
    }
  }
});

/* logout handler (top bar) */
document.addEventListener('click', (ev) => {
  if(ev.target && ev.target.classList && ev.target.classList.contains('logout')){
    signOut(auth).then(()=> showToast('Logged out'));
  }
});

/* ---------------- AUTH STATE ---------------- */
onAuthStateChanged(auth, async (user) => {
  currentUser = user;
  if(user){
    // determine role from users collection
    userRole = 'student';
    try{
      const q = query(collection(db,'users'), where('email','==',user.email));
      const snap = await getDocs(q);
      if(!snap.empty){
        const d = snap.docs[0].data(); userRole = d.role || (user.email === ADMIN_EMAIL ? 'admin' : 'student');
      } else {
        userRole = user.email === ADMIN_EMAIL ? 'admin' : 'student';
      }
    }catch(e){
      userRole = user.email === ADMIN_EMAIL ? 'admin' : 'student';
    }
    // show only initial letter as avatar and no email/uid
    const userArea = document.getElementById('userArea');
    userArea.innerHTML = `<div style="display:flex;gap:10px;align-items:center">
      <div style="background:linear-gradient(90deg,var(--accent1),var(--accent2));width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700">${(user.email||'U').charAt(0).toUpperCase()}</div>
      <button class="btn secondary logout">Logout</button>
    </div>`;
    if(userRole === 'admin'){ adminNav.style.display = 'block'; adminPage.style.display = 'block'; } else { adminNav.style.display = 'none'; adminPage.style.display = 'none'; }
  } else {
    userRole = null;
    document.getElementById('userArea').innerHTML = '<button id="openLogin" class="btn">Login / Signup</button>';
    document.getElementById('openLogin').addEventListener('click', ()=> loginModal.style.display = 'flex');
    adminNav.style.display = 'none'; adminPage.style.display = 'none';
  }
  // refresh lists
  await loadCourses(); loadTests(); loadNotices();
});

/* ---------------- COURSES ---------------- */
async function loadCourses(){
  try{
    featuredEl.innerHTML = ''; courseListEl.innerHTML = '';
    const snap = await getDocs(collection(db,'courses'));
    coursesCache = [];
    snap.forEach(d => { const data = d.data(); data.id = d.id; coursesCache.push(data); });

    // featured
    const featured = coursesCache.slice(0,3);
    featured.forEach(c => {
      const el = document.createElement('div'); el.className = 'course-card';
      el.innerHTML = `
        <h3>${escapeHtml(c.title)}</h3>
        <div class="small">${escapeHtml(c.desc || '')}</div>
        <div style="margin-top:8px"><span class="badge ${c.type==='premium'?'premium':'free'}">${c.type || 'free'}</span></div>
        <div style="margin-top:10px"><button class="btn" data-id="${c.id}">${isJoined(c.id) ? 'OPEN NOW' : 'JOIN'}</button></div>
      `;
      el.querySelector('button').addEventListener('click', ()=> handleCourseClick(c));
      featuredEl.appendChild(el);
    });

    // all courses
    coursesCache.forEach(c => {
      const el = document.createElement('div'); el.className = 'course-card';
      el.innerHTML = `
        <h3>${escapeHtml(c.title)}</h3>
        <div class="small">${escapeHtml(c.desc || '')}</div>
        <div style="margin-top:8px"><span class="badge ${c.type==='premium'?'premium':'free'}">${c.type || 'free'}</span></div>
        <div style="margin-top:10px"><button class="btn" data-id="${c.id}">${isJoined(c.id) ? 'OPEN NOW' : 'JOIN'}</button></div>
      `;
      el.querySelector('button').addEventListener('click', ()=> handleCourseClick(c));
      courseListEl.appendChild(el);
    });
  }catch(e){ console.error('loadCourses', e); showToast('Could not load courses'); }
}

/* join check via localStorage (quick) */
function isJoined(courseId){
  const joined = JSON.parse(localStorage.getItem('joinedCourses') || '[]');
  return joined.includes(courseId);
}
function markJoined(courseId){
  const j = JSON.parse(localStorage.getItem('joinedCourses') || '[]');
  if(!j.includes(courseId)){ j.push(courseId); localStorage.setItem('joinedCourses', JSON.stringify(j)); }
}

/* when user clicks join/open */
async function handleCourseClick(course){
  if(!currentUser){ loginModal.style.display = 'flex'; return; }
  if(course.type === 'premium' && userRole !== 'admin' && !isJoined(course.id)){
    const msg = encodeURIComponent(`I want to purchase the course: ${course.title}`);
    window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`, '_blank'); return;
  }
  if(!isJoined(course.id)){
    try{ await addDoc(collection(db,'enrollments'), { userId: currentUser.uid, courseId: course.id, createdAt: serverTimestamp() }); } catch(e){ console.warn('enroll save failed', e); }
    markJoined(course.id); showToast('Joined course');
  }
  openCourseView(course);
}

/* open course page */
async function openCourseView(course){
  currentOpenCourse = course;
  courseTitleEl.textContent = course.title;
  courseTypeEl.textContent = (course.type || 'free').toUpperCase();
  materialsEl.innerHTML = '';
  // materials may be stored inside course doc as array
  const mats = course.materials || [];
  if(!mats.length) materialsEl.innerHTML = '<div class="small">No materials added</div>';
  mats.forEach(m=>{
    const s = document.createElement('div'); s.className = 'subject';
    s.innerHTML = `<div><div class="title">${escapeHtml(m.title)}</div><div class="small" style="opacity:.85">${escapeHtml(m.link)}</div></div><div><button class="btn small">OPEN</button></div>`;
    s.querySelector('button').addEventListener('click', ()=> window.open(m.link, '_blank'));
    materialsEl.appendChild(s);
  });
  showPage('courseView');
}

/* back */
backBtn.addEventListener('click', ()=> showPage('courses'));

/* ---------------- TESTS & NOTICES ---------------- */
async function loadTests(){
  try{
    const snap = await getDocs(collection(db,'tests'));
    const testList = document.getElementById('testList');
    testList.innerHTML = '';
    snap.forEach(d => {
      const t = d.data(); const row = document.createElement('div'); row.className='course-card';
      row.innerHTML = `<h3>${escapeHtml(t.title)}</h3><div class="small">${(t.questions||[]).length} questions</div><div style="margin-top:10px"><button class="btn">Take Test</button></div>`;
      testList.appendChild(row);
    });
  } catch(e){ console.error('loadTests', e); document.getElementById('testList').innerHTML = '<div class="small">No tests</div>'; }
}

async function loadNotices(){
  try{
    const snap = await getDocs(collection(db,'notices'));
    const el = document.getElementById('noticeList'); el.innerHTML = '';
    snap.forEach(d => { const n = d.data(); const row = document.createElement('div'); row.className='course-card'; row.innerHTML = `<div>${escapeHtml(n.text)}</div><div class="small" style="margin-top:8px">${new Date(n.createdAt?.toDate?.()||n.createdAt||Date.now()).toLocaleString()}</div>`; el.appendChild(row); });
  } catch(e){ console.error('loadNotices', e); document.getElementById('noticeList').innerHTML = '<div class="small">No notices</div>'; }
}

/* ---------------- DASHBOARD ---------------- */
async function renderDashboard(){
  const el = document.getElementById('dashboardContent'); el.innerHTML = '';
  if(!currentUser){ el.innerHTML = '<div class="small">Login to see dashboard</div>'; return; }
  try{
    const joined = JSON.parse(localStorage.getItem('joinedCourses') || '[]');
    if(!joined.length){ el.innerHTML = '<div class="small">You have not joined any course</div>'; return; }
    const userCourses = coursesCache.filter(c => joined.includes(c.id));
    userCourses.forEach(c => {
      const card = document.createElement('div'); card.className='course-card';
      card.innerHTML = `<h3>${escapeHtml(c.title)}</h3><div class="small">${escapeHtml(c.desc||'')}</div><div style="margin-top:10px"><button class="btn">Open</button></div>`;
      card.querySelector('button').addEventListener('click', ()=> openCourseView(c));
      el.appendChild(card);
    });
  } catch(e){ console.error('dashboard', e); el.innerHTML = '<div class="small">Could not load dashboard</div>'; }
}

/* ---------------- ADMIN: add / edit / delete courses & materials ---------------- */
/* add material UI for create course */
addMatBtn.addEventListener('click', ()=> {
  const t = matTitle.value.trim(); const l = matLink.value.trim();
  if(!t || !l){ showToast('Material title and link required'); return; }
  adminMaterials.push({ title: t, link: l });
  const row = document.createElement('div'); row.className = 'adminMaterial'; row.textContent = `${t} — ${l}`;
  row.style.padding = '8px'; materialsEditor.appendChild(row);
  matTitle.value = matLink.value = '';
});

/* create course */
saveCourseBtn.addEventListener('click', async ()=> {
  const title = adminTitle.value.trim(); const desc = adminDesc.value.trim(); const type = adminType.value;
  if(!title) return showToast('Title required');
  try{
    await addDoc(collection(db,'courses'), { title, desc, type, materials: adminMaterials, createdAt: serverTimestamp() });
    adminTitle.value = adminDesc.value = ''; adminMaterials = []; materialsEditor.innerHTML = '';
    showToast('Course created'); await loadCourses(); loadAdminLists();
  } catch(e){ console.error('create course failed', e); showToast('Create failed'); }
});

/* admin lists */
async function loadAdminLists(){
  adminCourses.innerHTML = '';
  try{
    const snap = await getDocs(collection(db,'courses'));
    snap.forEach(d => {
      const c = d.data(); c.id = d.id;
      const row = document.createElement('div'); row.className = 'admin-row';
      row.innerHTML = `<div><strong>${escapeHtml(c.title)}</strong><div class="small">${escapeHtml(c.desc||'')}</div></div>
        <div style="display:flex;gap:8px">
          <button class="btn secondary" data-id="${c.id}" data-title="${escapeHtml(c.title)}">Edit</button>
          <button class="btn" style="background:rgba(239,68,68,0.12)" data-del="${c.id}">Delete</button>
        </div>`;
      adminCourses.appendChild(row);
    });
    // attach listeners
    adminCourses.querySelectorAll('button[data-del]').forEach(b => b.addEventListener('click', async ()=> {
      const id = b.getAttribute('data-del');
      if(!confirm('Delete this course?')) return;
      try{ await deleteDoc(doc(db,'courses', id)); showToast('Deleted'); await loadCourses(); loadAdminLists(); } catch(e){ console.error(e); showToast('Delete failed'); }
    }));
    adminCourses.querySelectorAll('button[data-id]').forEach(b => b.addEventListener('click', ()=> {
      const id = b.getAttribute('data-id');
      openAdminEditModal(id);
    }));
  } catch(e){ console.error('admin lists', e); adminCourses.innerHTML = '<div class="small">Could not load</div>'; }
}

/* Edit modal with full material add/delete */
async function openAdminEditModal(courseId){
  try{
    const dref = doc(db,'courses', courseId);
    const dSnap = await getDoc(dref);
    if(!dSnap.exists()){ showToast('Course not found'); return; }
    const data = dSnap.data();
    const modalHtml = `
      <h3 style="margin-top:0">Edit Course</h3>
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="__edit_title" class="input" value="${escapeHtml(data.title||'')}" />
        <textarea id="__edit_desc" class="input" style="min-height:80px">${escapeHtml(data.desc||'')}</textarea>
        <select id="__edit_type" class="input"><option value="free">Free</option><option value="premium">Premium</option></select>
        <div style="margin-top:8px"><strong>Materials</strong></div>
        <div id="__materials_list" style="display:flex;flex-direction:column;gap:8px;max-height:240px;overflow:auto;padding-top:6px"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="__mat_title" class="input" placeholder="Material title" />
          <input id="__mat_link" class="input" placeholder="Material link (https://...)" />
          <button id="__mat_add" class="btn" style="padding:8px 10px">Add</button>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="__edit_cancel" class="btn secondary">Cancel</button>
          <button id="__edit_save" class="btn">Save</button>
        </div>
      </div>
    `;
    const { container, box } = showModal(modalHtml);
    $('__edit_type').value = data.type || 'free';
    let materialArray = Array.isArray(data.materials) ? data.materials.slice() : [];
    const matListEl = $('__materials_list');
    function renderMaterials(){
      matListEl.innerHTML = '';
      if(materialArray.length === 0){
        const p = document.createElement('div'); p.className = 'small'; p.textContent = 'No materials';
        matListEl.appendChild(p); return;
      }
      materialArray.forEach((m, idx) => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.alignItems = 'center';
        row.style.gap = '8px';
        row.style.padding = '8px';
        row.style.borderRadius = '8px';
        row.style.background = 'rgba(255,255,255,0.02)';
        row.innerHTML = `<div style="max-width:70%"><div style="font-weight:600">${escapeHtml(m.title)}</div><div class="small" style="opacity:.85">${escapeHtml(m.link)}</div></div>
                         <div style="display:flex;gap:8px">
                           <button class="btn small" data-open="${idx}">Open</button>
                           <button class="btn secondary small" data-del="${idx}">Delete</button>
                         </div>`;
        row.querySelector('button[data-open]').addEventListener('click', ()=> window.open(m.link, '_blank'));
        row.querySelector('button[data-del]').addEventListener('click', ()=>{
          if(!confirm('Remove this material?')) return;
          materialArray.splice(idx,1);
          renderMaterials();
        });
        matListEl.appendChild(row);
      });
    }
    renderMaterials();

    $('__mat_add').addEventListener('click', ()=> {
      const t = $('__mat_title').value.trim(); const l = $('__mat_link').value.trim();
      if(!t || !l){ showToast('Provide title and link'); return; }
      materialArray.push({ title: t, link: l });
      $('__mat_title').value = ''; $('__mat_link').value = '';
      renderMaterials();
    });

    $('__edit_cancel').addEventListener('click', ()=> container.remove());

    $('__edit_save').addEventListener('click', async ()=> {
      const newTitle = $('__edit_title').value.trim();
      const newDesc = $('__edit_desc').value.trim();
      const newType = $('__edit_type').value;
      if(!newTitle){ showToast('Title required'); return; }
      try{
        await updateDoc(dref, { title: newTitle, desc: newDesc, type: newType, materials: materialArray, updatedAt: serverTimestamp() });
        container.remove(); showToast('Course updated'); await loadCourses(); loadAdminLists();
      } catch(err){ console.error('save edit', err); showToast('Update failed'); }
    });

  } catch(e){ console.error('openAdminEditModal', e); showToast('Cannot open editor'); }
}

/* ---------------- SEARCH & FILTER ---------------- */
filterType.addEventListener('change', ()=> {
  const v = filterType.value;
  const filtered = v==='all' ? coursesCache : coursesCache.filter(c=>c.type===v);
  courseListEl.innerHTML = '';
  filtered.forEach(c=>{
    const el = document.createElement('div'); el.className='course-card';
    el.innerHTML = `<h3>${escapeHtml(c.title)}</h3><div class="small">${escapeHtml(c.desc||'')}</div><div style="margin-top:8px"><span class="badge ${c.type==='premium'?'premium':'free'}">${c.type||'free'}</span></div><div style="margin-top:10px"><button class="btn">${isJoined(c.id)?'OPEN NOW':'JOIN'}</button></div>`;
    el.querySelector('button').addEventListener('click', ()=> handleCourseClick(c));
    courseListEl.appendChild(el);
  });
});

searchInput.addEventListener('input', ()=> {
  const q = searchInput.value.trim().toLowerCase();
  if(!q) return loadCourses();
  const filtered = coursesCache.filter(c => (c.title||'').toLowerCase().includes(q) || (c.desc||'').toLowerCase().includes(q));
  courseListEl.innerHTML = '';
  filtered.forEach(c=>{
    const el = document.createElement('div'); el.className='course-card';
    el.innerHTML = `<h3>${escapeHtml(c.title)}</h3><div class="small">${escapeHtml(c.desc||'')}</div><div style="margin-top:8px"><span class="badge ${c.type==='premium'?'premium':'free'}">${c.type||'free'}</span></div><div style="margin-top:10px"><button class="btn">${isJoined(c.id)?'OPEN NOW':'JOIN'}</button></div>`;
    el.querySelector('button').addEventListener('click', ()=> handleCourseClick(c));
    courseListEl.appendChild(el);
  });
});

/* ---------------- INITIAL LOAD ---------------- */
loadCourses(); loadTests(); loadNotices();

/* expose appState for debugging */
window.appState = ()=> ({ currentUser, userRole, coursesCacheLen: coursesCache.length });

</script>
</body>
</html>
